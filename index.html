<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ANIMAX PREMIUM </title>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        :root { 
            --gold: #D4AF37; 
            --dark-gold: #AA8C2C;
            --black: #050505; 
            --glass: rgba(20, 20, 20, 0.95);
            --border: 1px solid rgba(212, 175, 55, 0.3);
            --neon-glow: 0 0 12px rgba(212, 175, 55, 0.4);
            --red: #ff3b3b;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: 'Outfit', sans-serif; background: #000; color: #fff; overflow-x: hidden; padding-bottom: 70px; }

        /* --- Animations --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* --- Auth Screen --- */
        #auth-screen {
            position: fixed; inset: 0; z-index: 10000;
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px;
        }
        .auth-box {
            background: rgba(255, 255, 255, 0.03); padding: 40px 30px; border-radius: 20px; width: 100%; max-width: 350px;
            text-align: center; backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 0 40px rgba(0,0,0,0.8); animation: fadeIn 0.6s ease-out;
        }
        .auth-box h2 { font-family: 'Orbitron'; font-size: 28px; color: #fff; margin-bottom: 30px; letter-spacing: 2px; }
        .auth-box h2 span { color: var(--gold); text-shadow: var(--neon-glow); }
        
        input { 
            width: 100%; padding: 15px; margin-bottom: 15px; border-radius: 12px; 
            border: 1px solid #333; background: rgba(0,0,0,0.5); color: #fff; 
            font-family: 'Outfit'; text-align: center; transition: 0.3s;
        }
        input:focus { border-color: var(--gold); box-shadow: var(--neon-glow); }

        .btn-royal {
            width: 100%; padding: 15px; border-radius: 12px; border: none; font-weight: 700;
            background: linear-gradient(45deg, var(--dark-gold), var(--gold)); color: #000;
            font-family: 'Orbitron'; cursor: pointer; letter-spacing: 1px; margin-top: 10px;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
        }
        .btn-royal:active { transform: scale(0.98); }

        /* --- Main UI Structure --- */
        .app-view { display: none; padding-top: 60px; animation: fadeIn 0.4s; }
        
        header { 
            padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; 
            background: rgba(0,0,0,0.9); position: fixed; top: 0; left: 0; right: 0; z-index: 100; border-bottom: var(--border); 
            backdrop-filter: blur(10px);
        }
        .logo { font-family: 'Orbitron'; font-weight: 900; font-size: 20px; letter-spacing: 1px; }
        .logo span { color: var(--gold); }

        /* Slider */
        #banner-slider, #movie-banner-slider { 
            width: calc(100% - 30px); height: 180px; margin: 15px auto; border-radius: 15px; 
            overflow: hidden; position: relative; border: var(--border); box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }
        .slide { position: absolute; inset: 0; opacity: 0; transition: 1s; background-size: cover; background-position: center; }
        .slide.active { opacity: 1; }

        /* Section Title */
        .section-title {
            padding: 0 15px; margin-top: 25px; margin-bottom: 15px;
            font-family: 'Orbitron'; color: var(--gold); letter-spacing: 1px; font-size: 14px; 
            display:flex; align-items:center; justify-content: space-between;
        }

        /* GRID 4 SYSTEM */
        .grid-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; padding: 0 10px; }
        .folder-card { 
            position: relative; border-radius: 8px; overflow: hidden; background: #111; 
            border: 1px solid #222; aspect-ratio: 2/3; transition: 0.2s;
        }
        .folder-card:active { transform: scale(0.95); }
        .folder-card img { width: 100%; height: 100%; object-fit: cover; }
        .folder-info { 
            position: absolute; bottom: 0; width: 100%; padding: 5px; 
            background: linear-gradient(to top, #000 10%, transparent); text-align: center; 
        }
        .folder-title { font-size: 9px; font-family: 'Orbitron'; color: #fff; text-shadow: 0 1px 3px #000; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- Movie Box Specifics --- */
        #movie-box-view { background: #0a0a0a; min-height: 100vh; }
        .movie-header { background: #1a0505; border-bottom: 1px solid #ff3b3b; }
        .movie-header .logo span { color: #ff3b3b; }
        
        /* --- Shorts --- */
        #shorts-view { 
            position: fixed; inset: 0; background: #000; z-index: 200; 
            padding: 0; overflow-y: scroll; scroll-snap-type: y mandatory; 
        }
        .short-item {
            width: 100%; height: 100vh; scroll-snap-align: start; position: relative;
            background: #111; display: flex; align-items: center; justify-content: center;
        }
        .short-item video { width: 100%; height: 100%; object-fit: cover; }
        .short-overlay {
            position: absolute; bottom: 80px; right: 10px; display: flex; flex-direction: column; gap: 20px; z-index: 10;
        }
        .short-btn { color: #fff; text-align: center; font-size: 24px; text-shadow: 0 2px 5px #000; }
        .short-btn span { display: block; font-size: 10px; font-family: 'Orbitron'; margin-top: 5px; }

        /* --- Player & Social --- */
        #player-view { 
            position: fixed; inset: 0; background: #000; z-index: 5000; overflow-y: auto; display: none; 
        }
        .video-wrapper { position: sticky; top: 0; z-index: 5001; background: #000; width: 100%; aspect-ratio: 16/9; }
        video { width: 100%; height: 100%; }

        .social-bar {
            display: flex; justify-content: space-around; padding: 15px; background: #111; border-bottom: 1px solid #222;
        }
        .social-action { text-align: center; color: #888; font-size: 18px; }
        .social-action.active { color: var(--gold); animation: pulse 0.3s ease; }
        .social-action span { display: block; font-size: 10px; font-family: 'Orbitron'; margin-top: 5px; }

        .comment-section { padding: 15px; padding-bottom: 100px; }
        .comment-box {
            display: flex; margin-bottom: 15px; background: #0a0a0a; padding: 10px; border-radius: 8px; border: 1px solid #222;
        }
        .c-avatar { width: 30px; height: 30px; background: #333; border-radius: 50%; margin-right: 10px; color: var(--gold); display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .c-body h4 { font-size: 12px; color: var(--gold); margin-bottom: 3px; }
        .c-body p { font-size: 11px; color: #ccc; }

        /* --- Navigation --- */
        nav { 
            position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); width: 90%; 
            background: rgba(15, 15, 15, 0.95); backdrop-filter: blur(15px); border-radius: 25px; 
            padding: 12px; display: flex; justify-content: space-around; border: 1px solid #333; z-index: 1000;
            box-shadow: 0 5px 20px rgba(0,0,0,0.8);
        }
        nav i { font-size: 20px; color: #555; transition: 0.3s; padding: 10px; border-radius: 50%; }
        nav i.active { color: #000; background: var(--gold); box-shadow: var(--neon-glow); }

        /* --- Footer --- */
        .dev-footer {
            text-align: center; padding: 20px; margin-top: 30px; border-top: 1px solid #222;
            font-family: 'Orbitron'; font-size: 10px; color: #444;
        }
        
        /* AD Container Styling - Initially Empty */
        .ad-container-center {
            display: flex; justify-content: center; align-items: center;
            margin: 15px 0; overflow: hidden; width: 100%; min-height: 1px;
        }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-box" id="login-form">
            <h2>ANIMAX <span>PREMIUM</span></h2>
            <input type="email" id="email-in" placeholder="Email Address">
            <input type="password" id="pass-in" placeholder="Password">
            <button class="btn-royal" onclick="handleAuth('login')">LOGIN</button>
            <p style="margin-top:20px; font-size:11px; color:#888; cursor: pointer;" onclick="toggleAuth()">Create New Account</p>
        </div>
        <div class="auth-box" id="reg-form" style="display:none;">
            <h2>JOIN <span>ROYAL</span></h2>
            <input type="email" id="remail-in" placeholder="Valid Email">
            <input type="password" id="rpass-in" placeholder="Strong Password">
            <button class="btn-royal" onclick="handleAuth('reg')">REGISTER</button>
            <p style="margin-top:20px; font-size:11px; color:#888; cursor: pointer;" onclick="toggleAuth()">Back to Login</p>
        </div>
    </div>

    <div id="main-app" class="app-view">
        <header>
            <div class="logo">ANIMAX <span>PREMIUM</span></div>
            <i class="fas fa-search" style="color:#fff; font-size:18px;"></i>
        </header>

        <div id="banner-slider"></div>

        <div id="ad-banner-top" class="ad-container-center"></div>
        
        <div class="section-title">
            <span><i class="fas fa-bolt" style="color:var(--gold)"></i> NEW RELEASE</span>
            <span style="font-size:10px; color:#666">See All</span>
        </div>

        <div id="anime-grid" class="grid-container"></div>

        <div class="dev-footer">Developed by RJ Rocky</div>
    </div>

    <div id="movie-box-view" class="app-view">
        <header class="movie-header">
            <div class="logo">MOVIE <span>BOX</span></div>
            <i class="fas fa-sign-out-alt" style="color:#fff;" onclick="switchInterface('main')"></i>
        </header>

        <div id="movie-banner-slider"></div>

        <div class="section-title">
            <span style="color:#ff3b3b"><i class="fas fa-film"></i> TRENDING MOVIES</span>
        </div>

        <div id="movie-grid" class="grid-container"></div>
    </div>

    <div id="shorts-view" style="display:none;">
        <div style="position:fixed; top:20px; left:20px; z-index:101; color:#fff;" onclick="hideShorts()">
            <i class="fas fa-arrow-left" style="background:rgba(0,0,0,0.5); padding:10px; border-radius:50%;"></i>
        </div>
        <div id="shorts-container"></div>
    </div>

    <div id="player-view">
        <div class="video-wrapper">
            <div style="position:absolute; top:15px; left:15px; z-index:10;" onclick="closePlayer()">
                <i class="fas fa-arrow-left" style="font-size:18px; color:#fff; background:rgba(0,0,0,0.6); padding:10px; border-radius:50%;"></i>
            </div>
            <video id="main-video" controls playsinline></video>
        </div>

        <div class="social-bar">
            <div class="social-action" id="like-btn" onclick="toggleLike()">
                <i class="fas fa-heart"></i>
                <span id="like-count">0</span>
            </div>
            <div class="social-action">
                <i class="fas fa-eye"></i>
                <span id="view-count">0</span>
            </div>
            <div class="social-action" onclick="shareContent()">
                <i class="fas fa-share-alt"></i>
                <span>Share</span>
            </div>
        </div>

        <div id="ad-banner-player" class="ad-container-center"></div>

        <div style="padding:15px;">
            <h3 id="player-title" style="font-family:'Orbitron'; font-size:16px; color:var(--gold); margin-bottom:5px;">Episode Title</h3>
            <p style="font-size:11px; color:#666;">Real-time comments</p>
        </div>

        <div class="comment-section">
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <input type="text" id="comment-input" placeholder="Add a comment..." style="margin-bottom:0;">
                <button class="btn-royal" style="width:60px; margin-top:0;" onclick="postComment()"><i class="fas fa-paper-plane"></i></button>
            </div>
            <div id="comments-list"></div>
        </div>
    </div>

    <div id="profile-view" class="app-view" style="background:#050505; height:100vh; overflow-y:auto;">
        <div style="height:150px; background:url('https://c4.wallpaperflare.com/wallpaper/295/163/719/anime-anime-boys-picture-in-picture-kimetsu-no-yaiba-kamado-tanjir%C5%8D-hd-wallpaper-preview.jpg') center/cover; position:relative;">
            <div style="position:absolute; bottom:-40px; left:50%; transform:translateX(-50%); width:100px; height:100px; border-radius:50%; border:3px solid var(--gold); background:#000; overflow:hidden;">
                <img src="https://cdn-icons-png.flaticon.com/512/149/149071.png" style="width:100%; height:100%;">
            </div>
        </div>
        
        <div style="text-align:center; margin-top:50px;">
            <h2 id="profile-name" style="font-family:'Orbitron';">USER</h2>
            <div id="vip-badge" style="display:inline-block; padding:5px 15px; border:1px solid #333; border-radius:20px; font-size:10px; margin-top:5px; color:#666;">FREE ACCOUNT</div>
        </div>

        <div style="padding:20px;">
            <button class="btn-royal" style="background:linear-gradient(45deg, #ff3b3b, #800000); color:#fff; margin-bottom:15px;" onclick="switchInterface('movie')">
                <i class="fas fa-film"></i> MOVIE BOX SWITCH
            </button>

            <div style="background:#111; padding:15px; border-radius:10px; border:1px solid #222; margin-bottom:15px;">
                <h4 style="color:var(--gold); font-family:'Orbitron'; font-size:12px; margin-bottom:10px;"><i class="fas fa-lock"></i> VIP LOCKER</h4>
                <input type="password" id="locker-pin" placeholder="Set/Enter PIN" style="margin-bottom:5px;">
                <button style="width:100%; background:#222; border:none; color:#fff; padding:8px; border-radius:5px;" onclick="alert('Locker Feature Coming Soon!')">ACCESS</button>
            </div>

            <h3 style="font-family:'Orbitron'; font-size:14px; margin-bottom:10px;">HISTORY</h3>
            <div id="watchlist-container" style="max-height:150px; overflow-y:auto; margin-bottom:20px;"></div>

            <div style="background:linear-gradient(45deg, #111, #220000); padding:15px; border-radius:10px; border:1px solid var(--gold);">
                <h4 style="color:var(--gold); font-family:'Orbitron'; margin-bottom:10px;">PREMIUM ACCESS</h4>
                <input type="text" id="prem-code" placeholder="Enter License Code">
                <button class="btn-royal" onclick="redeemCode()">REDEEM CODE</button>
                <button class="btn-royal" style="background:#0088cc; color:#fff; margin-top:5px;" onclick="buyPremium()">
                    <i class="fab fa-telegram"></i> BUY PREMIUM
                </button>
            </div>

            <button onclick="auth.signOut()" style="width:100%; background:#333; border:none; color:#fff; padding:15px; margin-top:20px; border-radius:10px;">LOGOUT</button>
        </div>
    </div>

    <div id="ep-view" style="display:none; position:fixed; inset:0; background:#000; z-index:3000; overflow-y:auto;">
        <div style="padding:15px; border-bottom:1px solid #333; position:sticky; top:0; background:#000;">
            <i class="fas fa-arrow-left" onclick="document.getElementById('ep-view').style.display='none'" style="font-size:20px;"></i>
            <span id="folder-title-header" style="margin-left:15px; font-family:'Orbitron'; color:var(--gold);">SERIES</span>
        </div>
        <div id="ep-list" style="padding:15px;"></div>
    </div>

    <nav id="main-nav">
        <i class="fas fa-home active" onclick="switchTab('home')"></i>
        <i class="fas fa-play-circle" onclick="showShorts()"></i>
        <i class="fas fa-user" onclick="switchTab('profile')"></i>
    </nav>

    <script>
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBcWE5TCxamMSnJxqSm5X4mgSwSccIXcBI",
            authDomain: "myanimeapp-8d079.firebaseapp.com",
            databaseURL: "https://myanimeapp-8d079-default-rtdb.firebaseio.com",
            projectId: "myanimeapp-8d079",
            storageBucket: "myanimeapp-8d079.firebasestorage.app",
            messagingSenderId: "37482342893",
            appId: "1:37482342893:web:bebc7352e4bc102b725fe4"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(), db = firebase.database();

        let currentUser = null, isPremium = false, currentVideoId = null;
        let adSessionClick = false; // Track Smartlink clicks
        let adsLoaded = false; // Prevent double loading of script ads

        // --- AUTH SYSTEM ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                document.getElementById('profile-name').innerText = user.email.split('@')[0].toUpperCase();
                
                // IMPORTANT: Check Premium Status before loading anything else
                checkPremium(user.uid);
                
                loadContent();
                loadWatchlist();
            } else {
                document.getElementById('auth-screen').style.display = 'flex';
                document.getElementById('main-app').style.display = 'none';
                currentUser = null;
            }
        });

        // --- AD SYSTEM (DYNAMIC) ---
        function loadFreeUserAds() {
            if(adsLoaded) return; // Prevent multiple injections
            adsLoaded = true;
            console.log("Loading Free User Ads...");

            // 1. Social Bar Script
            let s1 = document.createElement('script');
            s1.src = "https://pl28670634.effectivegatecpm.com/2f/28/1a/2f281ac58d64e6a580eb2d4171fe33d7.js";
            document.body.appendChild(s1);

            // 2. Popunder Script
            let s2 = document.createElement('script');
            s2.src = "https://pl28670723.effectivegatecpm.com/66/84/a1/6684a1bcf20a187f5844b6e689ba4482.js";
            document.body.appendChild(s2);

            // 3. Banner 320x50 (Home Page)
            const bannerTop = document.getElementById('ad-banner-top');
            if(bannerTop) {
                bannerTop.innerHTML = `
                    <iframe src="javascript:false" title="" scrolling="no" frameborder="0" 
                    style="border:none; width:320px; height:50px; overflow:hidden;" 
                    srcdoc='<script>atOptions = { "key" : "9f634c6894bc13ff8f0f19de1fcac9f3", "format" : "iframe", "height" : 50, "width" : 320, "params" : {} };<\/script><script src="https://www.highperformanceformat.com/9f634c6894bc13ff8f0f19de1fcac9f3/invoke.js"><\/script>'></iframe>
                `;
            }

            // 4. Banner 468x60 (Player Page)
            const bannerPlayer = document.getElementById('ad-banner-player');
            if(bannerPlayer) {
                bannerPlayer.innerHTML = `
                    <iframe src="javascript:false" title="" scrolling="no" frameborder="0" 
                    style="border:none; width:468px; height:60px; overflow:hidden;" 
                    srcdoc='<script>atOptions = { "key" : "3c0655cdf72da98fdd68dcdd704f9766", "format" : "iframe", "height" : 60, "width" : 468, "params" : {} };<\/script><script src="https://www.highperformanceformat.com/3c0655cdf72da98fdd68dcdd704f9766/invoke.js"><\/script>'></iframe>
                `;
            }
        }

        function triggerSmartLink() {
            // ONLY trigger if User is NOT Premium
            if(isPremium) return;

            if(!adSessionClick) {
                window.open("https://www.effectivegatecpm.com/e3t9unhgv?key=2723dc497461b7507ba151e88ee0e871", "_blank");
                adSessionClick = true; 
            }
        }

        // --- PREMIUM CHECKER ---
        function checkPremium(uid) {
            db.ref(`users/${uid}`).on('value', s => {
                const d = s.val();
                if(d && d.premiumExpiry > Date.now()) {
                    // USER IS PREMIUM
                    isPremium = true;
                    document.getElementById('vip-badge').innerText = "ROYAL VIP MEMBER ðŸ‘‘";
                    document.getElementById('vip-badge').style.borderColor = "var(--gold)";
                    document.getElementById('vip-badge').style.color = "var(--gold)";
                    
                    // Hide Ad Containers just in case
                    document.getElementById('ad-banner-top').style.display = 'none';
                    document.getElementById('ad-banner-player').style.display = 'none';
                    
                } else {
                    // USER IS FREE
                    isPremium = false;
                    document.getElementById('vip-badge').innerText = "FREE ACCOUNT";
                    document.getElementById('vip-badge').style.borderColor = "#333";
                    document.getElementById('vip-badge').style.color = "#666";
                    
                    // Show Ad Containers and Load Scripts
                    document.getElementById('ad-banner-top').style.display = 'flex';
                    document.getElementById('ad-banner-player').style.display = 'flex';
                    loadFreeUserAds();
                }
            });
        }

        function handleAuth(type) {
            const e = document.getElementById(type === 'login' ? 'email-in' : 'remail-in').value;
            const p = document.getElementById(type === 'login' ? 'pass-in' : 'rpass-in').value;
            if (type === 'login') auth.signInWithEmailAndPassword(e, p).catch(err => alert(err.message));
            else auth.createUserWithEmailAndPassword(e, p).catch(err => alert(err.message));
        }
        function toggleAuth() {
            const l = document.getElementById('login-form'), r = document.getElementById('reg-form');
            l.style.display = l.style.display === 'none' ? 'block' : 'none';
            r.style.display = r.style.display === 'none' ? 'block' : 'none';
        }

        // --- NAVIGATION & UI ---
        function switchTab(tab) {
            document.querySelectorAll('.app-view').forEach(d => d.style.display = 'none');
            if (tab === 'home') document.getElementById('main-app').style.display = 'block';
            if (tab === 'profile') document.getElementById('profile-view').style.display = 'block';
            
            document.querySelectorAll('nav i').forEach(i => i.classList.remove('active'));
            if(tab === 'home') document.querySelector('.fa-home').classList.add('active');
            if(tab === 'profile') document.querySelector('.fa-user').classList.add('active');
        }

        function switchInterface(to) {
            document.querySelectorAll('.app-view').forEach(d => d.style.display = 'none');
            if(to === 'movie') {
                document.getElementById('movie-box-view').style.display = 'block';
                document.getElementById('main-nav').style.display = 'none';
                loadMovies();
            } else {
                document.getElementById('main-app').style.display = 'block';
                document.getElementById('main-nav').style.display = 'flex';
            }
        }

        // --- DATA LOADING ---
        function loadContent() {
            db.ref('banners').on('value', s => {
                const c = document.getElementById('banner-slider'); c.innerHTML = "";
                let i=0; s.forEach(b => { c.innerHTML += `<div class="slide ${i++===0?'active':''}" style="background-image:url('${b.val().image}')"></div>`; });
                startSlider('banner-slider');
            });

            db.ref('anime').on('value', snap => {
                const grid = document.getElementById('anime-grid'); grid.innerHTML = "";
                let folders = {};
                snap.forEach(c => {
                    let d = c.val(), f = d.folder || 'Misc';
                    if(!folders[f]) folders[f] = [];
                    folders[f].push(d);
                });
                
                Object.keys(folders).forEach(name => {
                    let thumb = folders[name][0].thumbnail;
                    grid.innerHTML += `
                        <div class="folder-card" onclick="openFolder('${name.replace(/'/g, "\\'")}')">
                            <img src="${thumb}">
                            <div class="folder-info"><div class="folder-title">${name}</div></div>
                        </div>`;
                });
                window.animeData = folders;
            });
        }

        function loadMovies() {
            db.ref('movies').on('value', snap => {
                const grid = document.getElementById('movie-grid'); grid.innerHTML = "";
                snap.forEach(c => {
                    let d = c.val();
                    grid.innerHTML += `
                        <div class="folder-card" onclick="playVideo('${d.title}', '${d.url}', '${d.id}', true)">
                            <img src="${d.thumbnail}">
                            <div class="folder-info"><div class="folder-title">${d.title}</div></div>
                        </div>`;
                });
            });
        }

        function openFolder(name) {
            document.getElementById('folder-title-header').innerText = name;
            const list = document.getElementById('ep-list'); list.innerHTML = "";
            document.getElementById('ep-view').style.display = 'block';
            
            window.animeData[name].forEach(ep => {
                list.innerHTML += `
                <div style="background:#111; padding:15px; border-radius:8px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;"
                     onclick="playVideo('${ep.title}', '${ep.url}', '${ep.id || Date.now()}', ${ep.type === 'premium'})">
                    <span style="font-size:12px;">${ep.title}</span>
                    <i class="fas ${ep.type==='premium'?'fa-crown':'fa-play'}" style="color:${ep.type==='premium'?'var(--gold)':'#fff'}"></i>
                </div>`;
            });
        }

        function startSlider(id) {
            setInterval(() => {
                let p = document.getElementById(id), a = p.querySelector('.active');
                if(a) { a.classList.remove('active'); (a.nextElementSibling || p.querySelector('.slide')).classList.add('active'); }
            }, 4000);
        }

        // --- PLAYER & SOCIAL ---
        function playVideo(title, url, id, isPrem) {
            if(isPrem && !isPremium) { alert("ROYAL VIP REQUIRED!"); switchTab('profile'); return; }
            
            // SMARTLINK TRIGGER (Only for Free Users)
            triggerSmartLink();

            currentVideoId = id;
            document.getElementById('player-title').innerText = title;
            const v = document.getElementById('main-video'); v.src = url; v.play();
            document.getElementById('player-view').style.display = 'block';
            
            db.ref(`users/${currentUser.uid}/watchlist/${id}`).set({title: title, date: Date.now()});
            
            db.ref(`views/${id}/${currentUser.uid}`).once('value', s => {
                if(!s.exists()) {
                    db.ref(`views/${id}/${currentUser.uid}`).set(true);
                    db.ref(`views/${id}/count`).transaction(c => (c || 0) + 1);
                }
            });

            loadSocialData(id);
        }

        function closePlayer() {
            document.getElementById('main-video').pause();
            document.getElementById('player-view').style.display = 'none';
        }

        function loadSocialData(id) {
            db.ref(`likes/${id}`).on('value', s => {
                const count = s.child('count').val() || 0;
                document.getElementById('like-count').innerText = count;
                const userLiked = s.child(currentUser.uid).exists();
                document.querySelector('#like-btn i').style.color = userLiked ? 'var(--red)' : '#888';
            });
            db.ref(`views/${id}/count`).on('value', s => document.getElementById('view-count').innerText = s.val() || 0);
            
            const list = document.getElementById('comments-list');
            db.ref(`comments/${id}`).on('child_added', s => {
                const c = s.val();
                list.innerHTML = `
                    <div class="comment-box">
                        <div class="c-avatar">${c.user[0]}</div>
                        <div class="c-body"><h4>${c.user}</h4><p>${c.text}</p></div>
                    </div>` + list.innerHTML;
            });
        }

        function toggleLike() {
            const ref = db.ref(`likes/${currentVideoId}`);
            ref.child(currentUser.uid).once('value', s => {
                if(s.exists()) {
                    ref.child(currentUser.uid).remove();
                    ref.child('count').transaction(c => c - 1);
                } else {
                    ref.child(currentUser.uid).set(true);
                    ref.child('count').transaction(c => (c || 0) + 1);
                }
            });
        }

        function postComment() {
            const txt = document.getElementById('comment-input').value;
            if(!txt) return;
            db.ref(`comments/${currentVideoId}`).push({
                user: currentUser.email.split('@')[0],
                text: txt,
                time: Date.now()
            });
            document.getElementById('comment-input').value = "";
        }

        function shareContent() {
            const link = `https://t.me/aminezone09`;
            navigator.clipboard.writeText(link).then(() => alert("Link Copied! Share on Telegram."));
        }

        // --- SHORTS ---
        function showShorts() {
            document.getElementById('shorts-view').style.display = 'block';
            const con = document.getElementById('shorts-container');
            if(con.children.length === 0) {
                db.ref('shorts').once('value', s => {
                    s.forEach(c => {
                        let d = c.val();
                        con.innerHTML += `
                        <div class="short-item">
                            <video src="${d.url}" loop onclick="this.paused?this.play():this.pause()"></video>
                            <div class="short-overlay">
                                <div class="short-btn" onclick="toggleLike('${d.id}')"><i class="fas fa-heart"></i><span>Like</span></div>
                                <div class="short-btn"><i class="fas fa-comment"></i><span>Comment</span></div>
                            </div>
                        </div>`;
                    });
                });
            }
        }
        function hideShorts() { document.getElementById('shorts-view').style.display = 'none'; }

        // --- PREMIUM SYSTEM & PROFILE ---
        function redeemCode() {
            const code = document.getElementById('prem-code').value.trim();
            db.ref(`premium_codes/${code}`).once('value', s => {
                if(s.exists() && s.val().status === 'unused') {
                    const days = s.val().days || 30;
                    const expiry = Date.now() + (days * 24 * 60 * 60 * 1000);
                    
                    db.ref(`premium_codes/${code}`).update({status: 'used', usedBy: currentUser.email});
                    db.ref(`users/${currentUser.uid}`).update({premiumExpiry: expiry});
                    alert(`SUCCESS! ${days} Days VIP Added.`);
                    location.reload();
                } else alert("Invalid or Used Code.");
            });
        }

        function buyPremium() {
            const msg = `Hi Admin, I want to buy Premium.\nUID: ${currentUser.uid}\nEmail: ${currentUser.email}`;
            window.open(`https://t.me/aminezone09?text=${encodeURIComponent(msg)}`, '_blank');
        }

        function loadWatchlist() {
            db.ref(`users/${currentUser.uid}/watchlist`).limitToLast(10).on('value', s => {
                const c = document.getElementById('watchlist-container'); c.innerHTML = "";
                if(!s.exists()) { c.innerHTML = "<p style='color:#444; font-size:10px;'>No history yet.</p>"; return; }
                s.forEach(i => {
                    c.innerHTML += `<div class="watch-item" onclick="alert('Play feature from history coming soon!')">
                        <div style="font-size:12px; color:#ccc;">${i.val().title}</div>
                    </div>`;
                });
            });
        }
    </script>
</body>
</html>
